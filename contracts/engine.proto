syntax = "proto3";

package engine;

option go_package = "github.com/ismailtsdln/forenscope/engine/proto";

service EngineService {
  // Performs a scan on a data source
  rpc Scan(ScanRequest) returns (ScanResult);
  
  // Performs file carving on a raw image or disk
  rpc Carve(CarveRequest) returns (CarveResult);
  
  // Calculates hashes for a given file or block
  rpc Hash(HashRequest) returns (HashResult);
  
  // Checks the health/status of the engine
  rpc Ping(Empty) returns (Pong);

  // Walks a directory and streams all file metadata (for Timeline)
  rpc Walk(WalkRequest) returns (stream WalkEntry);
}

message Empty {}

message Pong {
  string status = 1;
  int64 timestamp = 2;
}

message ScanRequest {
  string source_path = 1;
  string scan_type = 2; // "full", "quick", "custom"
  repeated string signatures = 3; // Optional: specific signature names to look for
  string yara_rule_path = 4; // Optional: Path to YARA rules file
}

message ScanResult {
  string job_id = 1;
  bool success = 2;
  int64 files_scanned = 3;
  repeated FoundItem matches = 4;
  string error_message = 5;
  repeated YaraMatch yara_matches = 6;
}

message YaraMatch {
  string file_path = 1;
  string rule_name = 2;
  repeated string tags = 3;
}

message FoundItem {
  string file_path = 1;
  string signature_name = 2;
  int64 offset = 3;
}

message CarveRequest {
  string source_path = 1;
  string output_dir = 2;
  int64 block_size = 3; // Default 4096
}

message CarveResult {
  string job_id = 1;
  bool success = 2;
  int64 files_recovered = 3;
  string error_message = 4;
}

message HashRequest {
  string file_path = 1;
  repeated string algorithms = 2; // e.g., ["sha256", "md5"]
}

message HashResult {
  string file_path = 1;
  map<string, string> hashes = 2; // algo -> hash_value
}

message WalkRequest {
  string root_path = 1;
}

message WalkEntry {
  string path = 1;
  int64 size = 2;
  int64 mode = 3;
  int64 modified_time = 4;
  int64 accessed_time = 5; // Might not be available on all OS
  int64 created_time = 6;  // Might not be available on all OS
  bool is_dir = 7;
}
